<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="quadkeyr">
<title>Converting Facebook Mobility QuadKey-identified Datasets into Raster Files â€¢ quadkeyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Converting Facebook Mobility QuadKey-identified Datasets into Raster Files">
<meta property="og:description" content="quadkeyr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">quadkeyr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quadkey_to_sf_conversion.html">From a QuadKey to a Simple Features data.frame and other conversions</a>
    <a class="dropdown-item" href="../articles/quadkey_identified_data_to_raster.html">Generating a Raster Image from Quadkey-Identified Data</a>
    <a class="dropdown-item" href="../articles/facebook_mobility_csvs_to_raster_files.html">Converting Facebook Mobility QuadKey-identified Datasets into Raster Files</a>
    <a class="dropdown-item" href="../articles/quadkey_visualization_app.html">QuadKey Visualization App</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Fernandez-Lab-WSU/quadkeyr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Converting Facebook Mobility QuadKey-identified Datasets into Raster Files</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Fernandez-Lab-WSU/quadkeyr/blob/HEAD/vignettes/facebook_mobility_csvs_to_raster_files.Rmd" class="external-link"><code>vignettes/facebook_mobility_csvs_to_raster_files.Rmd</code></a></small>
      <div class="d-none name"><code>facebook_mobility_csvs_to_raster_files.Rmd</code></div>
    </div>

    
    
<blockquote>
<p>Please, visit the <a href="https://fernandez-lab-wsu.github.io/quadkeyr/" class="external-link">README</a> for
general information about this package</p>
</blockquote>
<p>This section focuses on creating a raster from QuadKey data formatted
as provided by <a href="https://dataforgood.facebook.com/" class="external-link">Facebook
Mobility data</a>. If you want to convert other QuadKey-identified
datasets you can read <a href="https://fernandez-lab-wsu.github.io/quadkeyr/articles/quadkey_identified_data_to_raster.html" class="external-link">the
previous vignette.</a></p>
<p>Facebook mobility data for each location and zoom level is stored in
a separate <code>csv</code> file for each day and time.</p>
<div class="section level2">
<h2 id="basic-workflow">Basic workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"></a>
</h2>
<p><img src="../reference/figures/workflow_facebook.png" width="90%" style="display: block; margin: auto;"></p>
<div class="section level3">
<h3 id="reading-and-formatting-multiple-csv-files">Reading and formatting multiple <code>csv</code> Files<a class="anchor" aria-label="anchor" href="#reading-and-formatting-multiple-csv-files"></a>
</h3>
<ul>
<li><p>All this files are for the same area and zoom level, but dates
and hours will change.</p></li>
<li><p><code>read_fb_mobility_files</code> produce a warning in case
there are days or times missing.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_fb_mobility_files.html">read_fb_mobility_files</a></span><span class="op">(</span>path_to_csvs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,</span>
<span>                                              package <span class="op">=</span> <span class="st">"quadkeyr"</span><span class="op">)</span>, <span class="st">"/"</span><span class="op">)</span>,</span>
<span>                                colnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lat"</span>, <span class="st">"lon"</span>, </span>
<span>                                             <span class="st">"quadkey"</span>, <span class="st">"date_time"</span>, </span>
<span>                                             <span class="st">"n_crisis"</span>, <span class="st">"percent_change"</span><span class="op">)</span>,</span>
<span>                                coltypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                                  lat <span class="op">=</span> <span class="st">'d'</span>,</span>
<span>                                  lon <span class="op">=</span> <span class="st">'d'</span>,</span>
<span>                                  quadkey <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>                                  date_time <span class="op">=</span> <span class="st">'T'</span>,</span>
<span>                                  n_crisis <span class="op">=</span> <span class="st">'c'</span>,</span>
<span>                                  percent_change <span class="op">=</span> <span class="st">'c'</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">files</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 450 Ã— 8</span></span></span>
<span><span class="co">#&gt;      lat   lon quadkey    date_time           n_crisis percent_change day       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.86  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           -<span style="color: #BB0000;">2.60</span>  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.46  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.61  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            3.24  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.17  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     13.1         -<span style="color: #BB0000;">0.310</span> 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           11.4   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">18.3</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">15.7</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 440 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 1 more variable: hour &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-a-grid-and-merge">Create a grid and merge<a class="anchor" aria-label="anchor" href="#create-a-grid-and-merge"></a>
</h3>
<p>This function generates a <code>sf POLYGON data.frame</code> with a
<code>quadkey</code> and <code>geometry</code> column.</p>
<p>You might be wondering why weâ€™re not using the function weâ€™ve already
created, <code><a href="../reference/add_regular_polygon_grid.html">add_regular_polygon_grid()</a></code>, which adds a column
with QuadKey polygons, creating a regular grid, to an existing
<code>data.frame</code></p>
<p>There are two reasons for why weâ€™re using a different approach:</p>
<p>1 - The <code>read_fb_mobility_files</code> output contains multiple
datasets for the same area with the almost the same QuadKeys reported.
Using a function that calculates each QuadKey by row would unnecessarily
duplicate calculations.</p>
<p>2 - When you receive Facebook mobility data, you might not always get
exactly the same QuadKeys in all the files, even if they all report the
same area. This is especially important considering that you may be
receiving new files in the future.</p>
<p>Thatâ€™s why we create an <code>sf POLYGON</code> geometry data.frame,
retaining all the QuadKey polygons within the area of analysis, and then
proceed to join the results.</p>
<p>If creating the regular grid using the bounding box of the provided
QuadKeys may not work for your case, you can directly create the grid
for the full area of analysis using the <code><a href="../reference/create_qk_grid.html">create_qk_grid()</a></code>
function. Read the <a href="https://fernandez-lab-wsu.github.io/quadkeyr/articles/quadkey_identified_data_to_raster.html" class="external-link">the
previous vignette</a> to learn more about this function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">regular_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_regular_polygon_grid.html">get_regular_polygon_grid</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">files</span><span class="op">)</span></span>
<span><span class="va">regular_grid</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="co">#&gt; Simple feature collection with 396 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -58.60107 ymin: -34.60156 xmax: -58.5022 ymax: -34.50203</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 396 Ã— 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Rowwise: </span></span></span>
<span><span class="co">#&gt;    quadkey                                                  geometry tileX tileY</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                               <span style="color: #949494; font-style: italic;">&lt;POLYGON [Â°]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2103213001233302 ((-58.55713 -34.588, -58.55164 -34.588, -58.551â€¦ <span style="text-decoration: underline;">22</span>108 <span style="text-decoration: underline;">39</span>485</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2103213001213202 ((-58.5791 -34.51561, -58.57361 -34.51561, -58.â€¦ <span style="text-decoration: underline;">22</span>104 <span style="text-decoration: underline;">39</span>469</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2103213001233221 ((-58.57361 -34.59252, -58.56812 -34.59252, -58â€¦ <span style="text-decoration: underline;">22</span>105 <span style="text-decoration: underline;">39</span>486</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2103213001231110 ((-58.54614 -34.52919, -58.54065 -34.52919, -58â€¦ <span style="text-decoration: underline;">22</span>110 <span style="text-decoration: underline;">39</span>472</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2103213001320003 ((-58.52966 -34.53371, -58.52417 -34.53371, -58â€¦ <span style="text-decoration: underline;">22</span>113 <span style="text-decoration: underline;">39</span>473</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2103213001230110 ((-58.59009 -34.52919, -58.58459 -34.52919, -58â€¦ <span style="text-decoration: underline;">22</span>102 <span style="text-decoration: underline;">39</span>472</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2103213001212321 ((-58.59558 -34.52014, -58.59009 -34.52014, -58â€¦ <span style="text-decoration: underline;">22</span>101 <span style="text-decoration: underline;">39</span>470</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2103213001232302 ((-58.60107 -34.588, -58.59558 -34.588, -58.595â€¦ <span style="text-decoration: underline;">22</span>100 <span style="text-decoration: underline;">39</span>485</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2103213001322012 ((-58.52417 -34.56991, -58.51868 -34.56991, -58â€¦ <span style="text-decoration: underline;">22</span>114 <span style="text-decoration: underline;">39</span>481</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2103213001230320 ((-58.60107 -34.55634, -58.59558 -34.55634, -58â€¦ <span style="text-decoration: underline;">22</span>100 <span style="text-decoration: underline;">39</span>478</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 386 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">regular_grid</span><span class="op">$</span><span class="va">data</span>, </span>
<span>          color <span class="op">=</span> <span class="st">'red'</span>, </span>
<span>          linewidth <span class="op">=</span> <span class="fl">1.5</span>, </span>
<span>          fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/reg_grid-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>And later, we merge it with the <code>files</code> dataset. Weâ€™ve
chosen to use an <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::inner_join()</a></code> as it is the fastest
join method (cite) and will retain only the polygons reported in the
files.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">files_polygons</span> <span class="op">&lt;-</span> <span class="va">files</span> <span class="op">|&gt;</span> </span>
<span>                  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">regular_grid</span><span class="op">$</span><span class="va">data</span>, </span>
<span>                          by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"quadkey"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">files_polygons</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 450 Ã— 11</span></span></span>
<span><span class="co">#&gt;      lat   lon quadkey    date_time           n_crisis percent_change day       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.86  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           -<span style="color: #BB0000;">2.60</span>  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.46  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.61  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            3.24  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.17  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     13.1         -<span style="color: #BB0000;">0.310</span> 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           11.4   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">18.3</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">15.7</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 440 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 4 more variables: hour &lt;dbl&gt;, geometry &lt;POLYGON [Â°]&gt;, tileX &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   tileY &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Now that we have the polygons, letâ€™s create the raster files.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate the raster files                       </span></span>
<span><span class="fu"><a href="../reference/polygon_to_raster.html">polygon_to_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">files_polygons</span>,</span>
<span>                  nx <span class="op">=</span> <span class="va">regular_grid</span><span class="op">$</span><span class="va">num_cols</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                  ny <span class="op">=</span> <span class="va">regular_grid</span><span class="op">$</span><span class="va">num_rows</span><span class="op">+</span><span class="fl">1</span>,</span>
<span>                  template <span class="op">=</span> <span class="va">files_polygons</span>,</span>
<span>                  var <span class="op">=</span> <span class="st">'percent_change'</span>,</span>
<span>                  filename <span class="op">=</span> <span class="st">'cityA'</span>,</span>
<span>                  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                             package <span class="op">=</span> <span class="st">"quadkeyr"</span><span class="op">)</span>,</span>
<span>                                 <span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster</span> <span class="op">&lt;-</span> <span class="fu">read_stars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"quadkeyr"</span><span class="op">)</span>,</span>
<span>                                 <span class="st">"/cityA_2020-04-15_16.tif"</span><span class="op">)</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># More about plotting: </span></span>
<span><span class="co"># https://r-spatial.github.io/stars/reference/geom_stars.html</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stars</span><span class="op">(</span>data <span class="op">=</span> <span class="va">raster</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span></span>
<span>    <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_x_discrete</span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_y_discrete</span><span class="op">(</span>expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/qkgrid-1.png" width="90%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-use">Advanced use<a class="anchor" aria-label="anchor" href="#advanced-use"></a>
</h2>
<p>We will work with the output of the
<code>read_fb_mobility_files</code> function, the same that we have
already used in the basic workflow.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 450 Ã— 8</span></span></span>
<span><span class="co">#&gt;      lat   lon quadkey    date_time           n_crisis percent_change day       </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.86  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           -<span style="color: #BB0000;">2.60</span>  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.46  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            2.61  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            3.24  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>            1.17  2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     13.1         -<span style="color: #BB0000;">0.310</span> 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>           11.4   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.5</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">18.3</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 210321300â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>     <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">15.7</span>   2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 440 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 1 more variable: hour &lt;dbl&gt;</span></span></span></code></pre></div>
<div class="section level3">
<h3 id="convert-the-quadkey-grid-to-latitudelongitude-coordinates">Convert the QuadKey grid to latitude/longitude coordinates<a class="anchor" aria-label="anchor" href="#convert-the-quadkey-grid-to-latitudelongitude-coordinates"></a>
</h3>
<p>Even if these files correspond to the same area of analysis, they can
vary in the number of QuadKeys that are reported.</p>
<p>That is why we select from all the files all the QuadKeys that have
data at least once and convert them to a
<code>sf POINT data.frame</code> using
<code>quadkey_to_latlong</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># I get only the QuadKeys repeated in all the days and hours reported</span></span>
<span><span class="va">quadkeys</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">files</span><span class="op">$</span><span class="va">quadkey</span><span class="op">)</span></span>
<span></span>
<span><span class="va">qtll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quadkey_to_latlong.html">quadkey_to_latlong</a></span><span class="op">(</span>quadkeys <span class="op">=</span> <span class="va">quadkeys</span><span class="op">)</span></span>
<span><span class="va">qtll</span></span>
<span><span class="co">#&gt; Simple feature collection with 150 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -58.60107 ymin: -34.59704 xmax: -58.50769 ymax: -34.50203</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;              quadkey                    geometry</span></span>
<span><span class="co">#&gt; 150 2103213001322002 POINT (-58.53516 -34.56538)</span></span>
<span><span class="co">#&gt; 149 2103213001320010 POINT (-58.52417 -34.52466)</span></span>
<span><span class="co">#&gt; 148 2103213003011101 POINT (-58.55164 -34.59704)</span></span>
<span><span class="co">#&gt; 147 2103213001212132 POINT (-58.59009 -34.50203)</span></span>
<span><span class="co">#&gt; 146 2103213001233232 POINT (-58.56812 -34.59252)</span></span>
<span><span class="co">#&gt; 145 2103213001213300 POINT (-58.55713 -34.50656)</span></span>
<span><span class="co">#&gt; 144 2103213001213320 POINT (-58.55713 -34.51561)</span></span>
<span><span class="co">#&gt; 143 2103213001322120 POINT (-58.51318 -34.56991)</span></span>
<span><span class="co">#&gt; 142 2103213001322302 POINT (-58.51318 -34.58348)</span></span>
<span><span class="co">#&gt; 141 2103213001233100 POINT (-58.55713 -34.56086)</span></span></code></pre></div>
<p>Letâ€™s plot the QuadKey grid.</p>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="complete-the-grid">Complete the grid<a class="anchor" aria-label="anchor" href="#complete-the-grid"></a>
</h3>
<p>Some of the QuadKeys are missing, we canâ€™t consider this a regular
grid.</p>
<p>In order to create the polygons, letâ€™s complete the grid. Pay
attention that the output is a list with 3 elements: <code>data</code>,
<code>num_rows</code> and <code>num_cols</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regular_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regular_qk_grid.html">regular_qk_grid</a></span><span class="op">(</span><span class="va">qtll</span><span class="op">)</span></span>
<span><span class="va">regular_grid</span></span>
<span><span class="co">#&gt; $data</span></span>
<span><span class="co">#&gt; Simple feature collection with 396 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -58.60107 ymin: -34.59704 xmax: -58.50769 ymax: -34.50203</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;              quadkey                    geometry</span></span>
<span><span class="co">#&gt; 246 2103213001302123 POINT (-58.50769 -34.50203)</span></span>
<span><span class="co">#&gt; 245 2103213001302033 POINT (-58.51868 -34.50203)</span></span>
<span><span class="co">#&gt; 244 2103213001302032 POINT (-58.52417 -34.50203)</span></span>
<span><span class="co">#&gt; 243 2103213001302023 POINT (-58.52966 -34.50203)</span></span>
<span><span class="co">#&gt; 242 2103213001213133 POINT (-58.54065 -34.50203)</span></span>
<span><span class="co">#&gt; 241 2103213001213123 POINT (-58.55164 -34.50203)</span></span>
<span><span class="co">#&gt; 240 2103213001213122 POINT (-58.55713 -34.50203)</span></span>
<span><span class="co">#&gt; 239 2103213001213032 POINT (-58.56812 -34.50203)</span></span>
<span><span class="co">#&gt; 238 2103213001213023 POINT (-58.57361 -34.50203)</span></span>
<span><span class="co">#&gt; 237 2103213001213022  POINT (-58.5791 -34.50203)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $num_rows</span></span>
<span><span class="co">#&gt; [1] 21</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $num_cols</span></span>
<span><span class="co">#&gt; [1] 17</span></span></code></pre></div>
<p><code>num_cols</code> and <code>num_rows</code> refer to the number
of columns and rows, we will use this data to create the raster.</p>
<p>The original 150-point grid now has one point per row and cell,
resulting in a complete grid of 369 points, as depicted in the plot. The
additional points are highlighted in orange:</p>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="create-the-polygons">Create the polygons<a class="anchor" aria-label="anchor" href="#create-the-polygons"></a>
</h3>
<p>S</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Now we can transform the quadkeys into polygons</span></span>
<span><span class="va">polygrid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_to_polygon.html">grid_to_polygon</a></span><span class="op">(</span><span class="va">regular_grid</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">polygrid</span></span>
<span><span class="co">#&gt; Simple feature collection with 396 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -58.60107 ymin: -34.60156 xmax: -58.5022 ymax: -34.50203</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 396 Ã— 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Rowwise: </span></span></span>
<span><span class="co">#&gt;    quadkey                                                  geometry tileX tileY</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                               <span style="color: #949494; font-style: italic;">&lt;POLYGON [Â°]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2103213001233302 ((-58.55713 -34.588, -58.55164 -34.588, -58.551â€¦ <span style="text-decoration: underline;">22</span>108 <span style="text-decoration: underline;">39</span>485</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2103213001213202 ((-58.5791 -34.51561, -58.57361 -34.51561, -58.â€¦ <span style="text-decoration: underline;">22</span>104 <span style="text-decoration: underline;">39</span>469</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2103213001233221 ((-58.57361 -34.59252, -58.56812 -34.59252, -58â€¦ <span style="text-decoration: underline;">22</span>105 <span style="text-decoration: underline;">39</span>486</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2103213001231110 ((-58.54614 -34.52919, -58.54065 -34.52919, -58â€¦ <span style="text-decoration: underline;">22</span>110 <span style="text-decoration: underline;">39</span>472</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2103213001320003 ((-58.52966 -34.53371, -58.52417 -34.53371, -58â€¦ <span style="text-decoration: underline;">22</span>113 <span style="text-decoration: underline;">39</span>473</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2103213001230110 ((-58.59009 -34.52919, -58.58459 -34.52919, -58â€¦ <span style="text-decoration: underline;">22</span>102 <span style="text-decoration: underline;">39</span>472</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2103213001212321 ((-58.59558 -34.52014, -58.59009 -34.52014, -58â€¦ <span style="text-decoration: underline;">22</span>101 <span style="text-decoration: underline;">39</span>470</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2103213001232302 ((-58.60107 -34.588, -58.59558 -34.588, -58.595â€¦ <span style="text-decoration: underline;">22</span>100 <span style="text-decoration: underline;">39</span>485</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2103213001322012 ((-58.52417 -34.56991, -58.51868 -34.56991, -58â€¦ <span style="text-decoration: underline;">22</span>114 <span style="text-decoration: underline;">39</span>481</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2103213001230320 ((-58.60107 -34.55634, -58.59558 -34.55634, -58â€¦ <span style="text-decoration: underline;">22</span>100 <span style="text-decoration: underline;">39</span>478</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 386 more rows</span></span></span></code></pre></div>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Once I have the regular grid of QuadKeys for the bounding box and
zoom level, I combined the information with the data provided. I can
select the variables that will be part of the analysis and also create
new variables if needed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">polyvar</span> <span class="op">&lt;-</span> <span class="va">files</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">polygrid</span>, by <span class="op">=</span> <span class="st">'quadkey'</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">polyvar</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 Ã— 11</span></span></span>
<span><span class="co">#&gt;     lat   lon quadkey     date_time           n_crisis percent_change day       </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>           2.86 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>          -<span style="color: #BB0000;">2.60</span> 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> -<span style="color: #BB0000;">34.6</span> -<span style="color: #BB0000;">58.6</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>           1.46 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>           2.61 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.5</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>           3.24 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> -<span style="color: #BB0000;">34.5</span> -<span style="color: #BB0000;">58.6</span> 2103213001â€¦ 2020-04-15 <span style="color: #949494;">00:00:00</span>       <span style="color: #BB0000;">NA</span>           1.17 2020-04-15</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 4 more variables: hour &lt;dbl&gt;, geometry &lt;POLYGON [Â°]&gt;, tileX &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   tileY &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-the-rasters-for-the-variables-and-data-involved-">Create the rasters for the variables and data involved.<a class="anchor" aria-label="anchor" href="#create-the-rasters-for-the-variables-and-data-involved-"></a>
</h3>
<p>The rasters are going to be created automatically for each day and
time reported. Each raster will be created as
<code>&lt;filename&gt;_&lt;date&gt;_&lt;time&gt;.tif</code>. The
function <code>polygon_to_raster</code> will work even if there are some
days and times missing.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/polygon_to_raster.html">polygon_to_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">polyvar</span>,</span>
<span>                  nx <span class="op">=</span> <span class="va">regular_grid</span><span class="op">$</span><span class="va">num_cols</span> <span class="op">+</span><span class="fl">1</span> ,</span>
<span>                  ny <span class="op">=</span> <span class="va">regular_grid</span><span class="op">$</span><span class="va">num_rows</span> <span class="op">+</span><span class="fl">1</span> ,</span>
<span>                  template <span class="op">=</span> <span class="va">polyvar</span>,</span>
<span>                  var <span class="op">=</span> <span class="st">'percent_change'</span>,</span>
<span>                  filename <span class="op">=</span> <span class="st">'cityA'</span>,</span>
<span>                  path <span class="op">=</span> <span class="st">"../inst/extdata/"</span></span>
<span>                  <span class="op">)</span></span></code></pre></div>
<p>Letâ€™s plot one of the rasters, <code>"cityA_2020-04-15_8.tif"</code>.
As you can see, the overlapping with the polygon grid is perfect:</p>
<p><img src="facebook_mobility_csvs_to_raster_files_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Florencia Dâ€™Andrea.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
